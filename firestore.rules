rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================================================
       HELPERS
    ========================================================= */

    function signedIn() {
      return request.auth != null;
    }

    // Admin = existe doc /admins/{uid} e active == true
    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.active == true;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    /**
     * ✅ Campos permitidos para o PRÓPRIO usuário (client)
     * - inclui variações antigas para compatibilidade
     */
    function allowedUserKeys() {
      return [
        // identity/basic
        "uid",
        "email",
        "createdAt",
        "updatedAt",

        // profile
        "name",
        "phoneDigits",
        "phone",        // compat legado
        "photoUrl",
        "photoURL",     // compat legado

        // trial (compat + atual)
        "trialStartAt",
        "trialEndAt",
        "trialActive",
        "trialStart",
        "trialEnd",
        "trialEndsAt",

        // plan (mas com regras abaixo)
        "plan"
      ];
    }

    /**
     * ✅ No CREATE, o doc inteiro precisa estar dentro do allowlist
     */
    function createKeysAreSafe() {
      return request.resource.data.keys().hasOnly(allowedUserKeys());
    }

    /**
     * ✅ No UPDATE, só pode MUDAR campos dentro do allowlist
     */
    function updateKeysAreSafe() {
      return request.resource.data.diff(resource.data).changedKeys()
        .hasOnly(allowedUserKeys());
    }

    /**
     * ✅ PLAN: regras seguras
     * - CREATE: só aceita FREE/TRIAL (ou sem plan)
     * - UPDATE: permite qualquer plan EXISTENTE (FREE/TRIAL/PRO/VIP),
     *           mas o usuário NÃO pode ALTERAR o plan.
     */
    function planSafeForCreate() {
      return !("plan" in request.resource.data)
        || request.resource.data.plan in ["FREE", "TRIAL"];
    }

    function planNotChangedOnUpdate() {
      return !("plan" in request.resource.data)
        || resource.data.plan == request.resource.data.plan;
    }

    /**
     * ✅ TRIAL: usuário pode setar no CREATE (porque seu client cria trial),
     * mas NÃO pode alterar depois (somente admin).
     */
    function trialNotChangedOnUpdate() {
      return
        (!("trialStartAt" in request.resource.data) || request.resource.data.trialStartAt == resource.data.trialStartAt) &&
        (!("trialEndAt"   in request.resource.data) || request.resource.data.trialEndAt   == resource.data.trialEndAt) &&
        (!("trialActive"  in request.resource.data) || request.resource.data.trialActive  == resource.data.trialActive) &&
        (!("trialStart"   in request.resource.data) || request.resource.data.trialStart   == resource.data.trialStart) &&
        (!("trialEnd"     in request.resource.data) || request.resource.data.trialEnd     == resource.data.trialEnd) &&
        (!("trialEndsAt"  in request.resource.data) || request.resource.data.trialEndsAt  == resource.data.trialEndsAt);
    }

    function userCreateIsSafe() {
      return createKeysAreSafe() && planSafeForCreate();
    }

    function userUpdateIsSafe() {
      return updateKeysAreSafe() && planNotChangedOnUpdate() && trialNotChangedOnUpdate();
    }

    /* =========================================================
       ADMINS
    ========================================================= */

    match /admins/{uid} {
      allow get: if isOwner(uid) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if false; // somente via Console (por enquanto)
    }

    /* =========================================================
       USERS
    ========================================================= */

    match /users/{uid} {
      allow get: if isOwner(uid) || isAdmin();
      allow list: if isAdmin();

      // ✅ usuário pode criar o próprio doc (primeiro login/primeiro salvar)
      allow create: if isOwner(uid) && userCreateIsSafe();

      // ✅ usuário pode atualizar perfil com segurança (sem mexer plan/trial)
      allow update: if (isOwner(uid) && userUpdateIsSafe()) || isAdmin();

      // delete: só admin
      allow delete: if isAdmin();
    }

    /* =========================================================
       DADOS DO APP
    ========================================================= */

    match /draws/{drawId} {
      allow read: if signedIn();  // troque por true se quiser público
      allow write: if isAdmin();
    }

    match /draws/{drawId}/prizes/{prizeId} {
      allow read: if signedIn();  // troque por true se quiser público
      allow write: if isAdmin();
    }

    /* =========================================================
       DEFAULT: FECHA TUDO
    ========================================================= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
