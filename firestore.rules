rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================================================
       HELPERS
    ========================================================= */

    function signedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.active == true;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    // Aceita apenas FREE/TRIAL vindo do client (sem PRO/VIP na marra)
    function planIsSafe() {
      return !("plan" in request.resource.data)
        || request.resource.data.plan in ["FREE", "TRIAL"];
    }

    /**
     * ✅ Campos permitidos para o PRÓPRIO usuário (client)
     * - inclui variações de nomes para não quebrar builds antigos
     * - inclui campos de trial mais comuns
     */
    function allowedUserKeys() {
      return [
        "name",
        "phoneDigits",
        "phone",          // compat
        "photoUrl",
        "photoURL",       // compat
        "updatedAt",
        "createdAt",
        "trialStart",
        "trialEnd",
        "trialStartAt",   // compat
        "trialEndsAt",    // compat
        "plan"            // mas somente FREE/TRIAL (planIsSafe)
      ];
    }

    /**
     * ✅ Regra segura para CREATE/UPDATE
     * - update: só pode mudar campos dentro do allowlist
     * - create: doc inteiro também precisa estar no allowlist
     */
    function userWriteIsSafe() {
      return request.resource.data.diff(resource.data).changedKeys()
        .hasOnly(allowedUserKeys())
        && planIsSafe();
    }

    /* =========================================================
       ADMINS
    ========================================================= */

    match /admins/{uid} {
      allow get: if isOwner(uid) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if false;
    }

    /* =========================================================
       USERS
    ========================================================= */

    match /users/{uid} {
      allow get: if isOwner(uid) || isAdmin();
      allow list: if isAdmin();

      // ✅ usuário pode criar o próprio doc (primeiro SALVAR)
      allow create: if isOwner(uid) && userWriteIsSafe();

      // ✅ usuário pode atualizar apenas campos seguros
      allow update: if (isOwner(uid) && userWriteIsSafe()) || isAdmin();

      // delete: só admin
      allow delete: if isAdmin();
    }

    /* =========================================================
       DADOS DO APP
    ========================================================= */

    match /draws/{drawId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    match /draws/{drawId}/prizes/{prizeId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* =========================================================
       DEFAULT: FECHA TUDO
    ========================================================= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
