name: Auto Import — PalPitaco JB

on:
  schedule:
    # =========================
    # PT_RIO (RJ) — janelas BRT (UTC-3) convertidas p/ UTC
    # BRT 09:05–09:31 => UTC 12:05–12:31
    - cron: "5-31 12 * * 0-6"
    # BRT 11:05–11:31 => UTC 14:05–14:31
    - cron: "5-31 14 * * 0-6"
    # BRT 14:05–14:31 => UTC 17:05–17:31
    - cron: "5-31 17 * * 0-6"
    # BRT 16:05–16:31 => UTC 19:05–19:31
    - cron: "5-31 19 * * 0-6"

    # BRT 18:05–18:31 => UTC 21:05–21:31 (SEG, TER, QUI, SEX)
    - cron: "5-31 21 * * 1,2,4,5"

    # BRT 18:35 (one-shot) => UTC 21:35 (QUA e SÁB)
    - cron: "35 21 * * 3,6"

    # BRT 21:05–21:45 => UTC 0:05–0:45 (vira o dia no UTC; TER–DOM)
    # (Isso representa SEG–SÁB em BRT)
    - cron: "5-45 0 * * 0,2-6"

    # =========================
    # FEDERAL — Quarta e Sábado — janela BRT 19:49–20:10
    # BRT 19:49–19:59 => UTC 22:49–22:59
    - cron: "49-59 22 * * 3,6"
    # BRT 20:00–20:10 => UTC 23:00–23:10
    - cron: "0-10 23 * * 3,6"

  workflow_dispatch:
    inputs:
      lottery:
        description: "Qual loteria executar"
        required: true
        type: choice
        options:
          - PT_RIO
          - FEDERAL

# Garante que o Node rode em BRT (importante para regras de janela/slot no script)
env:
  TZ: America/Sao_Paulo

jobs:
  # ==========================================================
  # PT_RIO
  # ==========================================================
  run-import-pt-rio:
    name: run-import (PT_RIO)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    # Roda:
    # - em schedule, exceto quando for o schedule específico do FEDERAL
    # - ou manual quando input=PT_RIO
    if: |
      (github.event_name == 'schedule' &&
        github.event.schedule != '49-59 22 * * 3,6' &&
        github.event.schedule != '0-10 23 * * 3,6'
      )
      || (github.event_name == 'workflow_dispatch' && inputs.lottery == 'PT_RIO')

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Instalar dependências (backend)
        run: npm ci

      - name: Rodar importação automática (PT_RIO)
        env:
          # ✅ nome correto que o firebaseAdmin.js lê
          FIREBASE_ADMIN_SA_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          LOTTERY: PT_RIO
        run: node scripts/autoImportToday.js

  # ==========================================================
  # FEDERAL
  # ==========================================================
  run-import-federal:
    name: run-import (FEDERAL)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    # Roda:
    # - em schedule, SOMENTE nas duas regras do FEDERAL
    # - ou manual quando input=FEDERAL
    if: |
      (github.event_name == 'schedule' &&
        (github.event.schedule == '49-59 22 * * 3,6' || github.event.schedule == '0-10 23 * * 3,6')
      )
      || (github.event_name == 'workflow_dispatch' && inputs.lottery == 'FEDERAL')

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Instalar dependências (backend)
        run: npm ci

      - name: Rodar importação automática (FEDERAL)
        env:
          # ✅ nome correto que o firebaseAdmin.js lê
          FIREBASE_ADMIN_SA_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          LOTTERY: FEDERAL
        run: node scripts/autoImportToday.js
