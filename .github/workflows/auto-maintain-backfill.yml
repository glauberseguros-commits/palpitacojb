name: Auto Maintain Backfill (PT_RIO)

on:
  workflow_dispatch:
    inputs:
      days:
        description: "Janela de auditoria (dias)"
        required: true
        default: "60"
      limitDays:
        description: "Limite de dias por execuÃ§Ã£o de backfill"
        required: true
        default: "14"
  schedule:
    # Domingo 06:15 (BRT = UTC-3) => 09:15 UTC
    - cron: "15 9 * * 0"

concurrency:
  group: autopitaco-maintain-backfill
  cancel-in-progress: false

jobs:
  maintain:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      TZ: America/Sao_Paulo

      # âœ… robusto no Actions (sem quebra de newline)
      FIREBASE_ADMIN_SA_BASE64: ${{ secrets.FIREBASE_ADMIN_SA_BASE64 }}

      # âœ… garante projectId pro Firestore (evita "Unable to detect a Project Id")
      GOOGLE_CLOUD_PROJECT: palpitacojb-app
      GCLOUD_PROJECT: palpitacojb-app

      # Defaults (schedule)
      DAYS_DEFAULT: "60"
      LIMIT_DAYS_DEFAULT: "14"

      # ðŸ”’ Guardrails CI
      MAX_DAYS: "60"
      MAX_LIMIT_DAYS: "14"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install deps (backend)
        working-directory: backend
        run: npm ci

      - name: Guardrails (validate inputs)
        shell: bash
        run: |
          set -euo pipefail

          DAYS="${{ github.event_name == 'workflow_dispatch' && inputs.days || env.DAYS_DEFAULT }}"
          LIMIT_DAYS="${{ github.event_name == 'workflow_dispatch' && inputs.limitDays || env.LIMIT_DAYS_DEFAULT }}"

          is_int() { [[ "$1" =~ ^[0-9]+$ ]]; }

          if ! is_int "$DAYS"; then
            echo "::error::Input 'days' invÃ¡lido (precisa ser inteiro). Recebido: $DAYS"
            exit 1
          fi

          if ! is_int "$LIMIT_DAYS"; then
            echo "::error::Input 'limitDays' invÃ¡lido (precisa ser inteiro). Recebido: $LIMIT_DAYS"
            exit 1
          fi

          if (( DAYS > ${MAX_DAYS} )); then
            echo "::error::Guardrail: days=$DAYS excede MAX_DAYS=${MAX_DAYS}. Use <= ${MAX_DAYS}."
            exit 1
          fi

          if (( LIMIT_DAYS > ${MAX_LIMIT_DAYS} )); then
            echo "::error::Guardrail: limitDays=$LIMIT_DAYS excede MAX_LIMIT_DAYS=${MAX_LIMIT_DAYS}. Use <= ${MAX_LIMIT_DAYS}."
            exit 1
          fi

          echo "DAYS=$DAYS" >> "$GITHUB_ENV"
          echo "LIMIT_DAYS=$LIMIT_DAYS" >> "$GITHUB_ENV"

          echo "Resolved inputs:"
          echo "  DAYS=$DAYS"
          echo "  LIMIT_DAYS=$LIMIT_DAYS"

      - name: Run autoMaintainBackfill (PT_RIO)
        run: node backend/scripts/autoMaintainBackfill.js --lottery=PT_RIO --days=${{ env.DAYS }} --limitDays=${{ env.LIMIT_DAYS }} --baseMins=0,9 --tolMin=2
